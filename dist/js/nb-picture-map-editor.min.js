/*
 * nb-picture-map-editor
 * https://github.com/netbek/nb-picture-map-editor
 *
 * @author Hein Bekker <hein@netbek.co.za>
 * @copyright (c) 2015 Hein Bekker
 * @license http://www.gnu.org/licenses/agpl-3.0.txt AGPLv3
 */
!function(a,b){"use strict";b.module("nb.pictureMapEditor",["dialogService","ngDragDrop","nb.icon","nb.lodash","nb.picture","nb.pictureMapEditor.templates"])}(window,window.angular),function(a,b){"use strict";b.module("nb.pictureMapEditor").filter("style",function(){return function(a){var b="";return _.forEach(a,function(a,c){b+=c+": "+a+";"}),b}}).filter("trustedHtml",["$sce",function(a){return function(b){return a.trustAsHtml(b)}}])}(window,window.angular),function(a,b){"use strict";function c(){return{restrict:"EA",link:function(a,b){b.addClass("picture-map-editor")}}}b.module("nb.picture").directive("nbPictureMapEditor",c)}(window,window.angular),function(a,b){"use strict";function c(a,c,d,e,f,g){function h(){u(),i(),j()}function i(){s.initOverlay||(s.initOverlay=!0,a.overlay=g.getMapOverlay(o,r))}function j(){if(!s.initTools){s.initTools=!0,p={};var b=[],c=[];f.forEach(a.overlay.tools,function(a,d){if("group"===a.type){var e=[];f.forEach(a.tools,function(a,b){var g=d+"/"+b,h=f.pick(a,["icon","title"]);h.$$id=g,h.$$group=d,h.type="button",p[g]=h,e.push(h),a.active&&c.push(g)}),b.push({$$id:d,type:"group",tools:e})}else{var g=d,h=f.pick(a,["icon","title"]);h.$$id=g,h.$$group=d,h.type="button",p[d]=h,b.push(h),a.active&&c.push(g)}}),a.overlay.tools=b,f.forEach(c,function(a){k(a,!0)})}}function k(a,c){var d=a.split("/");if("debug"===d[0]){if(b.isUndefined(c)){var e=g.getMapOverlay(o,"editorDebug");c=!e.show}l(a,c),g[c?"showMapOverlay":"hideMapOverlay"](o,"editorDebug")}else"shape"===d[0]&&(q=d[1],m(a))}function l(b,c){p[b].$$active=c;var d=f.find(a.overlay.tools,{$$id:b});d&&(d.$$active=c)}function m(b,c){var d=b.split("/"),e=f.where(p,{$$group:d[0]});f.forEach(e,function(d){var e;if(c===!0||c===!1){if(d.$$id!==b)return;e=c}else e=d.$$id===b;d.$$active=e;var g=d.$$id.split("/"),h=f.find(a.overlay.tools,{$$group:g[0]});if(h){var i=f.find(h.tools,{$$id:b});i&&(i.$$active=c)}})}function n(a){var b=a.position(),d=b.left,e=b.top,f=a.outerWidth(),g=a.outerHeight(),h=c.outerWidth(),i=c.outerHeight();return 0>d?d=0:d+f>h&&(d=h-f),0>e?e=0:e+g>i&&(e=i-g),{top:e,left:d}}var o,p,q,r="editorUi",s={init:!1,initOverlay:!1,initTools:!1},t=[],u=b.noop;a.stopBarDrag=function(a){var b=jQuery(a.target),c=n(b);b.css(c)},a.clickButton=function(a){k(a)},this.init=function(){s.init||(s.init=!0,function(){var b=a.$watch("$parent.$parent.picture.$$id",function(a){a&&(o=a,b())});t.push(b)}(),function(){u=a.$watch("$parent.$parent.picture.$$complete",function(a){a&&h()}),t.push(u)}(),t.push(a.$on("nbPicture:baseLoad",function(){h()})))},this.destroy=function(){f.forEach(t,function(a){a()})}}b.module("nb.pictureMapEditor").controller("nbPictureMapEditorOverlayUiController",c),c.$inject=["$scope","$element","$attrs","$timeout","_","nbPictureService","nbPictureUtilService"]}(window,window.angular),function(a,b){"use strict";function c(){return{restrict:"EA",replace:!0,scope:!0,controller:"nbPictureMapEditorOverlayUiController",templateUrl:"templates/nb-picture-map-editor-overlay-ui.html",link:function(a,b,c,d){d.init(),a.$on("$destroy",function(){d.destroy()})}}}b.module("nb.pictureMapEditor").directive("nbPictureMapEditorOverlayUi",c)}(window,window.angular),function(a,b){"use strict";function c(a,c,d,e,f,g,h,i,j,k){function l(){u(),m(),a.$emit("nbPicture:mapAreasChanged",i.getMapAreas(q)),i.onBaseLoad(q,r)&&n()}function m(){s.initOverlay||(s.initOverlay=!0,a.overlay=i.getMapOverlay(q,r),t.push(a.$on("nbPicture:resize",n)),t.push(a.$on("nbPicture:render",n)))}function n(){var b=f.cloneDeep(i.getMapOverlayAreas(q,r));f.forEach(b,function(a){var b=h.getCenter(a.shape,a.$$coords,!0),c=h.getSize(a.shape,a.$$coords),d=Math.round((c.width+c.height)/2);a.$$style={top:b[1]+"px",left:b[0]+"px","font-size":d+"px"}}),a.areas=b}function o(c){var d,h=g.map.overlays.editorUi.areaDialog;d=b.isFunction(h.model)?h.model(c):h.model,d.$$map=i.getMap(q),j.open(h.id,h.templateUrl,d,h.options).then(function(b){i.setMapArea(q,f.merge({},c,b)),e(function(){a.$emit("nbPicture:mapAreasChanged",i.getMapAreas(q))})})}function p(a){return Number(Number(a).toFixed(3))}var q,r="editorUiAreas",s={init:!1,initOverlay:!1},t=[],u=b.noop,v=jQuery("body");a.areas=[],a.click=function(c){var d=jQuery(c.target);if(d.scope&&d.scope()===a){var j=!1,k=v.scrollTop()||0,l=v.scrollLeft()||0,m=d.parent(),n=m.offset(),r=m.outerWidth(),s=m.outerHeight(),t=l+c.clientX-n.left,u=k+c.clientY-n.top,w=t/r,x=u/s,y=i.getMap(q),z=g.map.overlays.editorUi.defaultArea,A={shape:f.cloneDeep(z.shape)};A.coords=b.isFunction(z.coords)?y.relCoords?z.coords(w,x):z.coords(t,u):f.cloneDeep(z.coords),A.$$coords=y.relCoords?h.relToAbsCoords(A.shape,A.coords,r,s,!0):f.cloneDeep(A.coords),A.coords=f.map(A.coords,p),A.$$coords=f.map(A.$$coords,p),A=i.setMapArea(q,A),A===!1||(j=!0,o(A)),j&&e(function(){a.$emit("nbPicture:mapAreasChanged",i.getMapAreas(q))})}},a.clickArea=function(a){var b=i.getMapArea(q,a);b&&o(b)},a.stopAreaDrag=function(b){var c=!1,d=jQuery(b.target),g=d.position(),j=d.scope().area.$$id,l=d.parent(),m=l.outerWidth(),n=l.outerHeight(),o=g.left,r=g.top,s=o/m,t=r/n,u=i.getMap(q),v=i.getMapArea(q,j),w=h.contains(k.RECTANGLE,[0,0,m,n],[o,r]);u&&v&&w?(u.relCoords?(v.coords[0]=s,v.coords[1]=t):(v.coords[0]=o,v.coords[1]=r),v.$$coords=u.relCoords?h.relToAbsCoords(v.shape,v.coords,m,n,!0):f.cloneDeep(v.coords),v.coords=f.map(v.coords,p),v.$$coords=f.map(v.$$coords,p),c=i.setMapArea(q,v)):c=i.deleteMapArea(q,j),c&&e(function(){a.$emit("nbPicture:mapAreasChanged",i.getMapAreas(q))})},this.init=function(){s.init||(s.init=!0,function(){var b=a.$watch("$parent.$parent.$parent.picture.$$id",function(a){a&&(q=a,b())});t.push(b)}(),function(){u=a.$watch("$parent.$parent.$parent.picture.$$complete",function(a){a&&l()}),t.push(u)}(),t.push(a.$on("nbPicture:baseLoad",function(){l()})),t.push(a.$on("nbPicture:baseError",function(){u(),i.onBaseError(q,r)&&n()})))},this.destroy=function(){f.forEach(t,function(a){a()})}}b.module("nb.pictureMapEditor").controller("nbPictureMapEditorOverlayUiAreasController",c),c.$inject=["$scope","$element","$attrs","$timeout","_","nbPictureConfig","nbPictureUtilService","nbPictureService","dialogService","PICTURE_SHAPE"]}(window,window.angular),function(a,b){"use strict";function c(){return{restrict:"EA",replace:!0,scope:!0,controller:"nbPictureMapEditorOverlayUiAreasController",templateUrl:"templates/nb-picture-map-editor-overlay-ui-areas.html",link:function(a,b,c,d){d.init(),a.$on("$destroy",function(){d.destroy()})}}}b.module("nb.pictureMapEditor").directive("nbPictureMapEditorOverlayUiAreas",c)}(window,window.angular),function(a,b){"use strict";function c(a,c,d,e,f,g,h,i,j,k){function l(){s(),m(),k.onBaseLoad(o,p)&&n()}function m(){q.initOverlay||(q.initOverlay=!0,a.overlay=k.getMapOverlay(o,p),r.push(a.overlay.debounceResize?a.$on("nbPicture:resize",h(n,a.overlay.debounceResize)):a.$on("nbPicture:resize",n)),r.push(a.$on("nbPicture:render",n)))}function n(){var b=i.map.overlays.editorDebug.build,c=g.cloneDeep(k.getMapOverlayAreas(o,p));g.forEach(c,function(a){a.$$centerCoords=j.getCenter(a.shape,a.$$coords,!0);var c=b(a);f.when(c.content).then(function(b){a.$$content=b},function(b){a.$$content=b}),f.when(c.style).then(function(b){a.$$style=b},function(b){a.$$style=b})}),a.areas=c}var o,p="editorDebug",q={init:!1,initOverlay:!1},r=[],s=b.noop;a.areas=[],this.init=function(){q.init||(q.init=!0,function(){var b=a.$watch("$parent.$parent.picture.$$id",function(a){a&&(o=a,b())});r.push(b)}(),function(){s=a.$watch("$parent.$parent.picture.$$complete",function(a){a&&l()}),r.push(s)}(),r.push(a.$on("nbPicture:baseLoad",function(){l()})),r.push(a.$on("nbPicture:baseError",function(){s(),k.onBaseError(o,p)&&n()})))},this.destroy=function(){g.forEach(r,function(a){a()})}}b.module("nb.pictureMapEditor").controller("nbPictureMapEditorOverlayDebugController",c),c.$inject=["$scope","$element","$attrs","$timeout","$q","debounce","_","nbPictureConfig","nbPictureUtilService","nbPictureService","dialogService","PICTURE_SHAPE"]}(window,window.angular),function(a,b){"use strict";function c(){return{restrict:"EA",replace:!0,scope:!0,controller:"nbPictureMapEditorOverlayDebugController",templateUrl:"templates/nb-picture-map-editor-overlay-debug.html",link:function(a,b,c,d){d.init(),a.$on("$destroy",function(){d.destroy()})}}}b.module("nb.pictureMapEditor").directive("nbPictureMapEditorOverlayDebug",c)}(window,window.angular),angular.module("nb.pictureMapEditor.templates",["templates/nb-picture-map-editor-overlay-debug.html","templates/nb-picture-map-editor-overlay-ui-areas.html","templates/nb-picture-map-editor-overlay-ui.html"]),angular.module("templates/nb-picture-map-editor-overlay-debug.html",[]).run(["$templateCache",function(a){a.put("templates/nb-picture-map-editor-overlay-debug.html",'<span class="picture-map-editor-overlay-debug"\n	  ng-show="overlay.show"\n	  ng-click="click($event)">\n	<span class="picture-map-editor-overlay-debug-popup"\n		  ng-if="area.$$content.length"\n		  ng-repeat="area in areas track by area.$$id"\n		  ng-attr-style="{{area.$$style|style}}">\n		<span ng-bind-html="area.$$content|trustedHtml"></span>\n	</span>\n</span>')}]),angular.module("templates/nb-picture-map-editor-overlay-ui-areas.html",[]).run(["$templateCache",function(a){a.put("templates/nb-picture-map-editor-overlay-ui-areas.html",'<span class="picture-map-editor-overlay-ui-areas"\n	  ng-click="click($event)">\n	<span class="picture-map-editor-overlay-ui-area"\n		  ng-repeat="area in areas track by area.$$id"\n		  ng-attr-style="{{area.$$style|style}}"\n		  ng-dblclick="clickArea(area.$$id)"\n		  jqyoui-draggable="{animate: true, onStop: \'stopAreaDrag\'}"\n		  data-drag="true">\n		<span nb-icon\n			  data-id="{{overlay.icon.id}}"\n			  data-hover-id="{{overlay.icon.hoverId}}"></span>\n	</span>\n</span>')}]),angular.module("templates/nb-picture-map-editor-overlay-ui.html",[]).run(["$templateCache",function(a){a.put("templates/nb-picture-map-editor-overlay-ui.html",'<div class="picture-map-editor-overlay-ui">\n	<div ng-if="overlay.tools.length"\n		 class="picture-map-editor-overlay-ui-bar"\n		 jqyoui-draggable="{animate: true, onStop: \'stopBarDrag\'}"\n		 data-drag="true">\n		<div class="picture-map-editor-overlay-ui-tools-handle"></div>\n		<ul class="picture-map-editor-overlay-ui-tools-content">\n			<li ng-repeat="group in overlay.tools track by group.$$id">\n				<div ng-switch="group.type">\n					<ul ng-switch-when="group"\n						class="picture-map-editor-overlay-ui-tools-group">\n						<li ng-repeat="tool in group.tools track by tool.$$id"\n							class="picture-map-editor-overlay-ui-tools-group-item">\n							<div ng-switch="tool.type">\n								<a ng-switch-when="button"\n								   ng-click="clickButton(tool.$$id)"\n								   ng-class="{\'active\': tool.$$active}"\n								   class="picture-map-editor-overlay-ui-tools-button"\n								   ng-attr-title="{{tool.title}}"\n								   ng-switch="tool.$$active">\n									<span ng-switch-when="true"\n										  nb-icon-once\n										  data-title="{{tool.title}}"\n										  data-color="{{overlay.buttonActiveColor}}"\n										  data-id="{{tool.icon.id}}"\n										  data-hover-id="{{tool.icon.hoverId}}"></span>\n									<span ng-switch-default\n										  nb-icon-once\n										  data-title="{{tool.title}}"\n										  data-color="{{overlay.buttonColor}}"\n										  data-id="{{tool.icon.id}}"\n										  data-hover-id="{{tool.icon.hoverId}}"></span>\n								</a>\n							</div>\n						</li>\n					</ul>\n					<div ng-switch-default\n						 class="picture-map-editor-overlay-ui-tools-single">\n						<div ng-switch="group.type">\n							<a ng-switch-when="button"\n							   ng-click="clickButton(group.$$id)"\n							   ng-class="{\'active\': group.$$active}"\n							   class="picture-map-editor-overlay-ui-tools-button"\n							   ng-attr-title="{{group.title}}"\n							   ng-switch="group.$$active">\n								<span ng-switch-when="true"\n									  nb-icon-once\n									  data-title="{{group.title}}"\n									  data-color="{{overlay.buttonActiveColor}}"\n									  data-id="{{group.icon.id}}"\n									  data-hover-id="{{group.icon.hoverId}}"></span>\n								<span ng-switch-default\n									  nb-icon-once\n									  data-title="{{group.title}}"\n									  data-color="{{overlay.buttonColor}}"\n									  data-id="{{group.icon.id}}"\n									  data-hover-id="{{group.icon.hoverId}}"></span>\n							</a>\n						</div>\n					</div>\n				</div>\n			</li>\n		</ul>\n	</div>\n	<div nb-picture-map-editor-overlay-ui-areas></div>\n</div>\n')}]);