/*
 * nb-picture-map-editor
 * https://github.com/netbek/nb-picture-map-editor
 *
 * @author Hein Bekker <hein@netbek.co.za>
 * @copyright (c) 2015 Hein Bekker
 * @license http://www.gnu.org/licenses/agpl-3.0.txt AGPLv3
 */
!function(a,b){"use strict";b.module("nb.pictureMapEditor",["dialogService","ngDragDrop","nb.icon","nb.lodash","nb.picture","nb.pictureMapEditor.templates"])}(window,window.angular),function(a,b){"use strict";b.module("nb.pictureMapEditor").filter("style",function(){return function(a){var b="";return _.forEach(a,function(a,c){b+=c+": "+a+";"}),b}})}(window,window.angular),function(a,b){"use strict";function c(a,c,d,e,f,g){function h(){m.render||(m.render=!0,f.forEach(a.overlay.buttons,function(b,c){a.overlay.buttons[c].$$id=c}),a.clickButton(f.keys(a.overlay.buttons)[0]))}function i(a){var b=a.position(),d=b.left,e=b.top,f=a.outerWidth(),g=a.outerHeight(),h=c.outerWidth(),i=c.outerHeight();return 0>d?d=0:d+f>h&&(d=h-f),0>e?e=0:e+g>i&&(e=i-g),{top:e,left:d}}var j,k,l="ui",m={init:!1,render:!1},n=[];a.stopBarDrag=function(a){var b=jQuery(a.target),c=i(b);b.css(c)},a.clickButton=function(b){k!==b&&(f.forEach(a.overlay.buttons,function(c,d){a.overlay.buttons[d].$active=d===b}),k=b)},this.init=function(){if(!m.init){m.init=!0,n.push(a.$watch("$parent.$parent.picture.$$id",function(a){a&&(j=a)}));var c=function(){d(),a.overlay=g.getMapOverlay(j,l),h()},d=b.noop;!function(){d=a.$watch("$parent.$parent.picture.$$complete",function(a){a&&c()}),n.push(d)}(),n.push(a.$on("nbPicture:baseLoad",function(){c()}))}},this.destroy=function(){f.forEach(n,function(a){a()})}}b.module("nb.pictureMapEditor").controller("nbPictureMapEditorOverlayUiController",c),c.$inject=["$scope","$element","$attrs","$timeout","_","nbPictureService","nbPictureUtilService"]}(window,window.angular),function(a,b){"use strict";function c(){return{restrict:"EA",replace:!0,scope:!0,controller:"nbPictureMapEditorOverlayUiController",templateUrl:"templates/nb-picture-map-editor-overlay-ui.html",link:function(a,b,c,d){d.init(),a.$on("$destroy",function(){d.destroy()})}}}b.module("nb.pictureMapEditor").directive("nbPictureMapEditorOverlayUi",c)}(window,window.angular),function(a,b){"use strict";function c(a,c,d,e,f,g,h,i,j,k){function l(){var b=i.getMapOverlayAreas(o,p);f.forEach(b,function(a,c){var d=h.getCenter(a.shape,a.$$coords,!0),e=h.getSize(a.shape,a.$$coords),f=Math.round((e.width+e.height)/2);b[c].style={top:d[1]+"px",left:d[0]+"px","font-size":f+"px"}}),a.areas=b}function m(c){var d,h=g.map.overlays.ui.areaDialog;d=b.isFunction(h.model)?h.model(c):h.model,j.open(h.id,h.templateUrl,d,h.options).then(function(b){i.setMapArea(o,f.merge({},c,b)),e(function(){a.$emit("nbPictureMapEditor:mapAreas",i.getMapAreas(o)),l(),a.$apply()})})}function n(a){return Number(Number(a).toFixed(3))}var o,p="uiAreas",q={init:!1},r=[];a.areas=[],a.click=function(c){var d=jQuery(c.target);if(d.scope&&d.scope()===a){var j=!1,k=d.parent(),q=k.offset(),r=k.outerWidth(),s=k.outerHeight(),t=c.clientX-q.left,u=c.clientY-q.top,v=t/r,w=u/s,x=i.getMap(o),y=g.map.overlays.ui.defaultArea,z={shape:f.cloneDeep(y.shape)};z.coords=b.isFunction(y.coords)?x.relCoords?y.coords(v,w):y.coords(t,u):f.cloneDeep(y.coords),z.$$coords=x.relCoords?h.relToAbsCoords(z.shape,z.coords,r,s,!0):f.cloneDeep(z.coords),z.coords=f.map(z.coords,n),z.$$coords=f.map(z.$$coords,n),z=i.setMapArea(o,z),z===!1||i.setMapOverlayArea(o,p,z)&&(j=!0,m(z)),j&&e(function(){a.$emit("nbPictureMapEditor:mapAreas",i.getMapAreas(o)),l(),a.$apply()})}},a.clickArea=function(a){var b=i.getMapArea(o,a);b&&m(b)},a.stopAreaDrag=function(b){var c=!1,d=jQuery(b.target),g=d.position(),j=d.scope().area.$$id,m=d.parent(),p=m.outerWidth(),q=m.outerHeight(),r=g.left,s=g.top,t=r/p,u=s/q,v=i.getMap(o),w=i.getMapArea(o,j),x=h.contains(k.RECTANGLE,[0,0,p,q],[r,s]);v&&w&&x?(v.relCoords?(w.coords[0]=t,w.coords[1]=u):(w.coords[0]=r,w.coords[1]=s),w.$$coords=v.relCoords?h.relToAbsCoords(w.shape,w.coords,p,q,!0):f.cloneDeep(w.coords),w.coords=f.map(w.coords,n),w.$$coords=f.map(w.$$coords,n),c=i.setMapArea(o,w)):c=i.deleteMapArea(o,j),c&&e(function(){a.$emit("nbPictureMapEditor:mapAreas",i.getMapAreas(o)),l(),a.$apply()})},this.init=function(){if(!q.init){q.init=!0,r.push(a.$watch("$parent.$parent.$parent.picture.$$id",function(a){a&&(o=a)}));var c=function(){d(),a.overlay=i.getMapOverlay(o,p),a.$emit("nbPictureMapEditor:mapAreas",i.getMapAreas(o)),i.onBaseLoad(o,p)&&l()},d=b.noop;!function(){d=a.$watch("$parent.$parent.$parent.picture.$$complete",function(a){a&&c()}),r.push(d)}(),r.push(a.$on("nbPicture:baseLoad",function(){c()})),r.push(a.$on("nbPicture:baseError",function(){d(),i.onBaseError(o,p)&&l()})),r.push(a.$on("nbPicture:resize",function(){i.onResize(o,p)&&l()}))}},this.destroy=function(){f.forEach(r,function(a){a()})}}b.module("nb.pictureMapEditor").controller("nbPictureMapEditorOverlayUiAreasController",c),c.$inject=["$scope","$element","$attrs","$timeout","_","nbPictureConfig","nbPictureUtilService","nbPictureService","dialogService","PICTURE_SHAPE"]}(window,window.angular),function(a,b){"use strict";function c(){return{restrict:"EA",replace:!0,scope:!0,controller:"nbPictureMapEditorOverlayUiAreasController",templateUrl:"templates/nb-picture-map-editor-overlay-ui-areas.html",link:function(a,b,c,d){d.init(),a.$on("$destroy",function(){d.destroy()})}}}b.module("nb.pictureMapEditor").directive("nbPictureMapEditorOverlayUiAreas",c)}(window,window.angular),angular.module("nb.pictureMapEditor.templates",["templates/nb-picture-map-editor-overlay-ui-areas.html","templates/nb-picture-map-editor-overlay-ui.html"]),angular.module("templates/nb-picture-map-editor-overlay-ui-areas.html",[]).run(["$templateCache",function(a){a.put("templates/nb-picture-map-editor-overlay-ui-areas.html",'<span class="picture-map-editor-overlay-ui-areas"\n	  ng-click="click($event)">\n	<span class="picture-map-editor-overlay-ui-area"\n		  ng-repeat="area in areas track by area.$$id"\n		  ng-attr-style="{{area.style|style}}"\n		  ng-dblclick="clickArea(area.$$id)"\n		  jqyoui-draggable="{animate: true, onStop: \'stopAreaDrag\'}"\n		  data-drag="true">\n		<span nb-icon\n			  data-id="{{overlay.icon.id}}"\n			  data-hover-id="{{overlay.icon.hoverId}}"></span>\n	</span>\n</span>')}]),angular.module("templates/nb-picture-map-editor-overlay-ui.html",[]).run(["$templateCache",function(a){a.put("templates/nb-picture-map-editor-overlay-ui.html",'<div class="picture-map-editor-overlay-ui">\n	<div class="picture-map-editor-overlay-ui-bar"\n		 jqyoui-draggable="{animate: true, onStop: \'stopBarDrag\'}"\n		 data-drag="true">\n		<div class="picture-map-editor-overlay-ui-bar-handle"></div>\n		<ul>\n			<li ng-repeat="button in overlay.buttons track by button.$$id">\n				<button ng-click="clickButton(button.$$id)"\n						ng-class="{\'active\': button.$active}"\n						ng-attr-title="{{button.title}}"\n						ng-switch="button.$active">\n					<span ng-switch-when="true"\n						  nb-icon-once\n						  data-title="{{button.title}}"\n						  data-color="{{overlay.buttonActiveColor}}"\n						  data-id="{{button.icon.id}}"\n						  data-hover-id="{{button.icon.hoverId}}"></span>\n					<span ng-switch-default\n						  nb-icon-once\n						  data-title="{{button.title}}"\n						  data-color="{{overlay.buttonColor}}"\n						  data-id="{{button.icon.id}}"\n						  data-hover-id="{{button.icon.hoverId}}"></span>\n				</button>\n			</li>\n		</ul>\n	</div>\n	<div nb-picture-map-editor-overlay-ui-areas></div>\n</div>\n')}]);