/*
 * nb-picture-map-editor
 * https://github.com/netbek/nb-picture-map-editor
 *
 * @author Hein Bekker <hein@netbek.co.za>
 * @copyright (c) 2015 Hein Bekker
 * @license http://www.gnu.org/licenses/agpl-3.0.txt AGPLv3
 */
!function(a,b){"use strict";b.module("nb.pictureMapEditor",["dialogService","ngDragDrop","nb.icon","nb.lodash","nb.picture","nb.pictureMapEditor.templates"])}(window,window.angular),function(a,b){"use strict";b.module("nb.pictureMapEditor").filter("style",function(){return function(a){var b="";return _.forEach(a,function(a,c){b+=c+": "+a+";"}),b}}).filter("trustedHtml",["$sce",function(a){return function(b){return a.trustAsHtml(b)}}])}(window,window.angular),function(a,b){"use strict";function c(){return{restrict:"EA",link:function(a,b){b.addClass("picture-map-editor")}}}b.module("nb.picture").directive("nbPictureMapEditor",c)}(window,window.angular),function(a,b){"use strict";function c(a,c,d,e,f,g){function h(){if(!q.initTools){q.initTools=!0,n={};var b=[],c=[];f.forEach(a.overlay.tools,function(a,d){if("group"===a.type){var e=[];f.forEach(a.tools,function(a,b){var g=d+"/"+b,h=f.pick(a,["icon","title"]);h.$$id=g,h.$$group=d,h.type="button",n[g]=h,e.push(h),a.active&&c.push(g)}),b.push({$$id:d,type:"group",tools:e})}else{var g=d,h=f.pick(a,["icon","title"]);h.$$id=g,h.$$group=d,h.type="button",n[d]=h,b.push(h),a.active&&c.push(g)}}),a.overlay.tools=b,f.forEach(c,function(a){i(a)})}}function i(a){var b=a.split("/");if("debug"===b[0]){var c=g.getMapOverlay(m,"editorDebug"),d=!c.show;j(a,d),g[d?"showMapOverlay":"hideMapOverlay"](m,"editorDebug")}else"shape"===b[0]&&(o=b[1],k(a))}function j(b,c){n[b].$$active=c;var d=f.find(a.overlay.tools,{$$id:b});d&&(d.$$active=c)}function k(b,c){var d=b.split("/"),e=f.where(n,{$$group:d[0]});f.forEach(e,function(d){var e;if(c===!0||c===!1){if(d.$$id!==b)return;e=c}else e=d.$$id===b;d.$$active=e;var g=d.$$id.split("/"),h=f.find(a.overlay.tools,{$$group:g[0]});if(h){var i=f.find(h.tools,{$$id:b});i&&(i.$$active=c)}})}function l(a){var b=a.position(),d=b.left,e=b.top,f=a.outerWidth(),g=a.outerHeight(),h=c.outerWidth(),i=c.outerHeight();return 0>d?d=0:d+f>h&&(d=h-f),0>e?e=0:e+g>i&&(e=i-g),{top:e,left:d}}var m,n,o,p="editorUi",q={init:!1,initTools:!1},r=[];a.stopBarDrag=function(a){var b=jQuery(a.target),c=l(b);b.css(c)},a.clickButton=function(a){i(a)},this.init=function(){if(!q.init){q.init=!0,r.push(a.$watch("$parent.$parent.picture.$$id",function(a){a&&(m=a)}));var c=function(){d(),a.overlay=g.getMapOverlay(m,p),h()},d=b.noop;!function(){d=a.$watch("$parent.$parent.picture.$$complete",function(a){a&&c()}),r.push(d)}(),r.push(a.$on("nbPicture:baseLoad",function(){c()}))}},this.destroy=function(){f.forEach(r,function(a){a()})}}b.module("nb.pictureMapEditor").controller("nbPictureMapEditorOverlayUiController",c),c.$inject=["$scope","$element","$attrs","$timeout","_","nbPictureService","nbPictureUtilService"]}(window,window.angular),function(a,b){"use strict";function c(){return{restrict:"EA",replace:!0,scope:!0,controller:"nbPictureMapEditorOverlayUiController",templateUrl:"templates/nb-picture-map-editor-overlay-ui.html",link:function(a,b,c,d){d.init(),a.$on("$destroy",function(){d.destroy()})}}}b.module("nb.pictureMapEditor").directive("nbPictureMapEditorOverlayUi",c)}(window,window.angular),function(a,b){"use strict";function c(a,c,d,e,f,g,h,i,j,k){function l(){var b=f.cloneDeep(i.getMapOverlayAreas(o,p));f.forEach(b,function(a){var b=h.getCenter(a.shape,a.$$coords,!0),c=h.getSize(a.shape,a.$$coords),d=Math.round((c.width+c.height)/2);a.$$style={top:b[1]+"px",left:b[0]+"px","font-size":d+"px"}}),a.areas=b}function m(c){var d,h=g.map.overlays.editorUi.areaDialog;d=b.isFunction(h.model)?h.model(c):h.model,j.open(h.id,h.templateUrl,d,h.options).then(function(b){i.setMapArea(o,f.merge({},c,b)),e(function(){a.$emit("nbPicture:mapAreasChanged",i.getMapAreas(o))})})}function n(a){return Number(Number(a).toFixed(3))}var o,p="editorUiAreas",q={init:!1},r=[],s=jQuery("body");a.areas=[],a.click=function(c){var d=jQuery(c.target);if(d.scope&&d.scope()===a){var j=!1,k=s.scrollTop()||0,l=s.scrollLeft()||0,p=d.parent(),q=p.offset(),r=p.outerWidth(),t=p.outerHeight(),u=l+c.clientX-q.left,v=k+c.clientY-q.top,w=u/r,x=v/t,y=i.getMap(o),z=g.map.overlays.editorUi.defaultArea,A={shape:f.cloneDeep(z.shape)};A.coords=b.isFunction(z.coords)?y.relCoords?z.coords(w,x):z.coords(u,v):f.cloneDeep(z.coords),A.$$coords=y.relCoords?h.relToAbsCoords(A.shape,A.coords,r,t,!0):f.cloneDeep(A.coords),A.coords=f.map(A.coords,n),A.$$coords=f.map(A.$$coords,n),A=i.setMapArea(o,A),A===!1||(j=!0,m(A)),j&&e(function(){a.$emit("nbPicture:mapAreasChanged",i.getMapAreas(o))})}},a.clickArea=function(a){var b=i.getMapArea(o,a);b&&m(b)},a.stopAreaDrag=function(b){var c=!1,d=jQuery(b.target),g=d.position(),j=d.scope().area.$$id,l=d.parent(),m=l.outerWidth(),p=l.outerHeight(),q=g.left,r=g.top,s=q/m,t=r/p,u=i.getMap(o),v=i.getMapArea(o,j),w=h.contains(k.RECTANGLE,[0,0,m,p],[q,r]);u&&v&&w?(u.relCoords?(v.coords[0]=s,v.coords[1]=t):(v.coords[0]=q,v.coords[1]=r),v.$$coords=u.relCoords?h.relToAbsCoords(v.shape,v.coords,m,p,!0):f.cloneDeep(v.coords),v.coords=f.map(v.coords,n),v.$$coords=f.map(v.$$coords,n),c=i.setMapArea(o,v)):c=i.deleteMapArea(o,j),c&&e(function(){a.$emit("nbPicture:mapAreasChanged",i.getMapAreas(o))})},this.init=function(){if(!q.init){q.init=!0,r.push(a.$watch("$parent.$parent.$parent.picture.$$id",function(a){a&&(o=a)}));var c=function(){d(),a.overlay=i.getMapOverlay(o,p),a.$emit("nbPicture:mapAreasChanged",i.getMapAreas(o)),i.onBaseLoad(o,p)&&l()},d=b.noop;!function(){d=a.$watch("$parent.$parent.$parent.picture.$$complete",function(a){a&&c()}),r.push(d)}(),r.push(a.$on("nbPicture:baseLoad",function(){c()})),r.push(a.$on("nbPicture:baseError",function(){d(),i.onBaseError(o,p)&&l()})),r.push(a.$on("nbPicture:resize",l)),r.push(a.$on("nbPicture:render",l))}},this.destroy=function(){f.forEach(r,function(a){a()})}}b.module("nb.pictureMapEditor").controller("nbPictureMapEditorOverlayUiAreasController",c),c.$inject=["$scope","$element","$attrs","$timeout","_","nbPictureConfig","nbPictureUtilService","nbPictureService","dialogService","PICTURE_SHAPE"]}(window,window.angular),function(a,b){"use strict";function c(){return{restrict:"EA",replace:!0,scope:!0,controller:"nbPictureMapEditorOverlayUiAreasController",templateUrl:"templates/nb-picture-map-editor-overlay-ui-areas.html",link:function(a,b,c,d){d.init(),a.$on("$destroy",function(){d.destroy()})}}}b.module("nb.pictureMapEditor").directive("nbPictureMapEditorOverlayUiAreas",c)}(window,window.angular),function(a,b){"use strict";function c(a,c,d,e,f,g,h,i){function j(){var b=g.map.overlays.editorDebug.build,c=f.cloneDeep(i.getMapOverlayAreas(k,l));f.forEach(c,function(a){a.$$centerCoords=h.getCenter(a.shape,a.$$coords,!0);var c=b(a);a.$$content=c.content,a.$$style=c.style}),a.areas=c}var k,l="editorDebug",m={init:!1},n=[];a.areas=[],this.init=function(){if(!m.init){m.init=!0,n.push(a.$watch("$parent.$parent.picture.$$id",function(a){a&&(k=a)}));var c=function(){d(),a.overlay=i.getMapOverlay(k,l),i.onBaseLoad(k,l)&&j()},d=b.noop;!function(){d=a.$watch("$parent.$parent.picture.$$complete",function(a){a&&c()}),n.push(d)}(),n.push(a.$on("nbPicture:baseLoad",function(){c()})),n.push(a.$on("nbPicture:baseError",function(){d(),i.onBaseError(k,l)&&j()})),n.push(a.$on("nbPicture:resize",j)),n.push(a.$on("nbPicture:render",j))}},this.destroy=function(){f.forEach(n,function(a){a()})}}b.module("nb.pictureMapEditor").controller("nbPictureMapEditorOverlayDebugController",c),c.$inject=["$scope","$element","$attrs","$timeout","_","nbPictureConfig","nbPictureUtilService","nbPictureService","dialogService","PICTURE_SHAPE"]}(window,window.angular),function(a,b){"use strict";function c(){return{restrict:"EA",replace:!0,scope:!0,controller:"nbPictureMapEditorOverlayDebugController",templateUrl:"templates/nb-picture-map-editor-overlay-debug.html",link:function(a,b,c,d){d.init(),a.$on("$destroy",function(){d.destroy()})}}}b.module("nb.pictureMapEditor").directive("nbPictureMapEditorOverlayDebug",c)}(window,window.angular),angular.module("nb.pictureMapEditor.templates",["templates/nb-picture-map-editor-overlay-debug.html","templates/nb-picture-map-editor-overlay-ui-areas.html","templates/nb-picture-map-editor-overlay-ui.html"]),angular.module("templates/nb-picture-map-editor-overlay-debug.html",[]).run(["$templateCache",function(a){a.put("templates/nb-picture-map-editor-overlay-debug.html",'<span class="picture-map-editor-overlay-debug"\n	  ng-show="overlay.show"\n	  ng-click="click($event)">\n	<span class="picture-map-editor-overlay-debug-popup"\n		  ng-repeat="area in areas track by area.$$id"\n		  ng-attr-style="{{area.$$style|style}}">\n		<span ng-bind-html="area.$$content|trustedHtml"></span>\n	</span>\n</span>')}]),angular.module("templates/nb-picture-map-editor-overlay-ui-areas.html",[]).run(["$templateCache",function(a){a.put("templates/nb-picture-map-editor-overlay-ui-areas.html",'<span class="picture-map-editor-overlay-ui-areas"\n	  ng-click="click($event)">\n	<span class="picture-map-editor-overlay-ui-area"\n		  ng-repeat="area in areas track by area.$$id"\n		  ng-attr-style="{{area.$$style|style}}"\n		  ng-dblclick="clickArea(area.$$id)"\n		  jqyoui-draggable="{animate: true, onStop: \'stopAreaDrag\'}"\n		  data-drag="true">\n		<span nb-icon\n			  data-id="{{overlay.icon.id}}"\n			  data-hover-id="{{overlay.icon.hoverId}}"></span>\n	</span>\n</span>')}]),angular.module("templates/nb-picture-map-editor-overlay-ui.html",[]).run(["$templateCache",function(a){a.put("templates/nb-picture-map-editor-overlay-ui.html",'<div class="picture-map-editor-overlay-ui">\n	<div ng-if="overlay.tools"\n		 class="picture-map-editor-overlay-ui-bar"\n		 jqyoui-draggable="{animate: true, onStop: \'stopBarDrag\'}"\n		 data-drag="true">\n		<div class="picture-map-editor-overlay-ui-tools-handle"></div>\n		<ul class="picture-map-editor-overlay-ui-tools-content">\n			<li ng-repeat="group in overlay.tools track by group.$$id">\n				<div ng-switch="group.type">\n					<ul ng-switch-when="group"\n						class="picture-map-editor-overlay-ui-tools-group">\n						<li ng-repeat="tool in group.tools track by tool.$$id"\n							class="picture-map-editor-overlay-ui-tools-group-item">\n							<div ng-switch="tool.type">\n								<a ng-switch-when="button"\n								   ng-click="clickButton(tool.$$id)"\n								   ng-class="{\'active\': tool.$$active}"\n								   class="picture-map-editor-overlay-ui-tools-button"\n								   ng-attr-title="{{tool.title}}"\n								   ng-switch="tool.$$active">\n									<span ng-switch-when="true"\n										  nb-icon-once\n										  data-title="{{tool.title}}"\n										  data-color="{{overlay.buttonActiveColor}}"\n										  data-id="{{tool.icon.id}}"\n										  data-hover-id="{{tool.icon.hoverId}}"></span>\n									<span ng-switch-default\n										  nb-icon-once\n										  data-title="{{tool.title}}"\n										  data-color="{{overlay.buttonColor}}"\n										  data-id="{{tool.icon.id}}"\n										  data-hover-id="{{tool.icon.hoverId}}"></span>\n								</a>\n							</div>\n						</li>\n					</ul>\n					<div ng-switch-default\n						 class="picture-map-editor-overlay-ui-tools-single">\n						<div ng-switch="group.type">\n							<a ng-switch-when="button"\n							   ng-click="clickButton(group.$$id)"\n							   ng-class="{\'active\': group.$$active}"\n							   class="picture-map-editor-overlay-ui-tools-button"\n							   ng-attr-title="{{group.title}}"\n							   ng-switch="group.$$active">\n								<span ng-switch-when="true"\n									  nb-icon-once\n									  data-title="{{group.title}}"\n									  data-color="{{overlay.buttonActiveColor}}"\n									  data-id="{{group.icon.id}}"\n									  data-hover-id="{{group.icon.hoverId}}"></span>\n								<span ng-switch-default\n									  nb-icon-once\n									  data-title="{{group.title}}"\n									  data-color="{{overlay.buttonColor}}"\n									  data-id="{{group.icon.id}}"\n									  data-hover-id="{{group.icon.hoverId}}"></span>\n							</a>\n						</div>\n					</div>\n				</div>\n			</li>\n		</ul>\n	</div>\n	<div nb-picture-map-editor-overlay-ui-areas></div>\n</div>\n')}]);