/*
 * nb-picture-map-editor
 * https://github.com/netbek/nb-picture-map-editor
 *
 * @author Hein Bekker <hein@netbek.co.za>
 * @copyright (c) 2015 Hein Bekker
 * @license http://www.gnu.org/licenses/agpl-3.0.txt AGPLv3
 */
!function(a,b){"use strict";b.module("nb.pictureMapEditor",["dialogService","ngDragDrop","nb.icon","nb.lodash","nb.picture","nb.pictureMapEditor.templates"])}(window,window.angular),function(a,b){"use strict";b.module("nb.pictureMapEditor").filter("style",function(){return function(a){var b="";return _.forEach(a,function(a,c){b+=c+": "+a+";"}),b}})}(window,window.angular),function(a,b){"use strict";function c(){return{restrict:"EA",link:function(a,b){b.addClass("picture-map-editor")}}}b.module("nb.picture").directive("nbPictureMapEditor",c)}(window,window.angular),function(a,b){"use strict";function c(a,c,d,e,f,g){function h(){if(!r.initTools){r.initTools=!0,n={};var b=[],c=[];f.forEach(a.overlay.tools,function(a,d){if("group"===a.type){var e=[];f.forEach(a.tools,function(a,b){var g=d+"/"+b,h=f.pick(a,["icon","title"]);h.$$id=g,h.$$group=d,h.type="button",n[g]=h,e.push(h),a.active&&c.push(g)}),b.push({$$id:d,type:"group",tools:e})}else{var g=d,h=f.pick(a,["icon","title"]);h.$$id=g,h.$$group=d,h.type="button",n[d]=h,b.push(h),a.active&&c.push(g)}}),a.overlay.tools=b,f.forEach(c,function(a){i(a)})}}function i(a){if(n&&n[a]){var b=a.split("/"),c=n[a];"debug"===b[0]?(c.$$active?(p=!1,j(a,!1)):(p=!0,j(a,!0)),console.log("toggle debug "+p)):"shape"===b[0]&&(o=b[1],k(a))}}function j(b,c){n[b].$$active=c;var d=f.find(a.overlay.tools,{$$id:b});d&&(d.$$active=c)}function k(b,c){var d=b.split("/"),e=f.where(n,{$$group:d[0]});f.forEach(e,function(d){var e;if(c===!0||c===!1){if(d.$$id!==b)return;e=c}else e=d.$$id===b;d.$$active=e;var g=d.$$id.split("/"),h=f.find(a.overlay.tools,{$$group:g[0]});if(h){var i=f.find(h.tools,{$$id:b});i&&(i.$$active=c)}})}function l(a){var b=a.position(),d=b.left,e=b.top,f=a.outerWidth(),g=a.outerHeight(),h=c.outerWidth(),i=c.outerHeight();return 0>d?d=0:d+f>h&&(d=h-f),0>e?e=0:e+g>i&&(e=i-g),{top:e,left:d}}var m,n,o,p,q="ui",r={init:!1,initTools:!1},s=[];a.stopBarDrag=function(a){var b=jQuery(a.target),c=l(b);b.css(c)},a.clickButton=function(a){i(a)},this.init=function(){if(!r.init){r.init=!0,s.push(a.$watch("$parent.$parent.picture.$$id",function(a){a&&(m=a)}));var c=function(){d(),a.overlay=g.getMapOverlay(m,q),h()},d=b.noop;!function(){d=a.$watch("$parent.$parent.picture.$$complete",function(a){a&&c()}),s.push(d)}(),s.push(a.$on("nbPicture:baseLoad",function(){c()}))}},this.destroy=function(){f.forEach(s,function(a){a()})}}b.module("nb.pictureMapEditor").controller("nbPictureMapEditorOverlayUiController",c),c.$inject=["$scope","$element","$attrs","$timeout","_","nbPictureService","nbPictureUtilService"]}(window,window.angular),function(a,b){"use strict";function c(){return{restrict:"EA",replace:!0,scope:!0,controller:"nbPictureMapEditorOverlayUiController",templateUrl:"../src/templates/nb-picture-map-editor-overlay-ui.html?_="+Date.now(),link:function(a,b,c,d){d.init(),a.$on("$destroy",function(){d.destroy()})}}}b.module("nb.pictureMapEditor").directive("nbPictureMapEditorOverlayUi",c)}(window,window.angular),function(a,b){"use strict";function c(a,c,d,e,f,g,h,i,j,k){function l(){var b=f.cloneDeep(i.getMapOverlayAreas(o,p));f.forEach(b,function(a,c){var d=h.getCenter(a.shape,a.$$coords,!0),e=h.getSize(a.shape,a.$$coords),f=Math.round((e.width+e.height)/2);b[c].style={top:d[1]+"px",left:d[0]+"px","font-size":f+"px"}}),a.areas=b}function m(c){var d,h=g.map.overlays.ui.areaDialog;d=b.isFunction(h.model)?h.model(c):h.model,j.open(h.id,h.templateUrl,d,h.options).then(function(b){i.setMapArea(o,f.merge({},c,b)),e(function(){a.$emit("nbPictureMapEditor:mapAreas",i.getMapAreas(o)),l(),a.$apply()})})}function n(a){return Number(Number(a).toFixed(3))}var o,p="uiAreas",q={init:!1},r=[],s=jQuery("body");a.areas=[],a.click=function(c){var d=jQuery(c.target);if(d.scope&&d.scope()===a){var j=!1,k=s.scrollTop()||0,p=s.scrollLeft()||0,q=d.parent(),r=q.offset(),t=q.outerWidth(),u=q.outerHeight(),v=p+c.clientX-r.left,w=k+c.clientY-r.top,x=v/t,y=w/u,z=i.getMap(o),A=g.map.overlays.ui.defaultArea,B={shape:f.cloneDeep(A.shape)};B.coords=b.isFunction(A.coords)?z.relCoords?A.coords(x,y):A.coords(v,w):f.cloneDeep(A.coords),B.$$coords=z.relCoords?h.relToAbsCoords(B.shape,B.coords,t,u,!0):f.cloneDeep(B.coords),B.coords=f.map(B.coords,n),B.$$coords=f.map(B.$$coords,n),B=i.setMapArea(o,B),B===!1||(j=!0,m(B)),j&&e(function(){a.$emit("nbPictureMapEditor:mapAreas",i.getMapAreas(o)),l(),a.$apply()})}},a.clickArea=function(a){var b=i.getMapArea(o,a);b&&m(b)},a.stopAreaDrag=function(b){var c=!1,d=jQuery(b.target),g=d.position(),j=d.scope().area.$$id,m=d.parent(),p=m.outerWidth(),q=m.outerHeight(),r=g.left,s=g.top,t=r/p,u=s/q,v=i.getMap(o),w=i.getMapArea(o,j),x=h.contains(k.RECTANGLE,[0,0,p,q],[r,s]);v&&w&&x?(v.relCoords?(w.coords[0]=t,w.coords[1]=u):(w.coords[0]=r,w.coords[1]=s),w.$$coords=v.relCoords?h.relToAbsCoords(w.shape,w.coords,p,q,!0):f.cloneDeep(w.coords),w.coords=f.map(w.coords,n),w.$$coords=f.map(w.$$coords,n),c=i.setMapArea(o,w)):c=i.deleteMapArea(o,j),c&&e(function(){a.$emit("nbPictureMapEditor:mapAreas",i.getMapAreas(o)),l(),a.$apply()})},this.init=function(){if(!q.init){q.init=!0,r.push(a.$watch("$parent.$parent.$parent.picture.$$id",function(a){a&&(o=a)}));var c=function(){d(),a.overlay=i.getMapOverlay(o,p),a.$emit("nbPictureMapEditor:mapAreas",i.getMapAreas(o)),i.onBaseLoad(o,p)&&l()},d=b.noop;!function(){d=a.$watch("$parent.$parent.$parent.picture.$$complete",function(a){a&&c()}),r.push(d)}(),r.push(a.$on("nbPicture:baseLoad",function(){c()})),r.push(a.$on("nbPicture:baseError",function(){d(),i.onBaseError(o,p)&&l()})),r.push(a.$on("nbPicture:resize",function(){l()}))}},this.destroy=function(){f.forEach(r,function(a){a()})}}b.module("nb.pictureMapEditor").controller("nbPictureMapEditorOverlayUiAreasController",c),c.$inject=["$scope","$element","$attrs","$timeout","_","nbPictureConfig","nbPictureUtilService","nbPictureService","dialogService","PICTURE_SHAPE"]}(window,window.angular),function(a,b){"use strict";function c(){return{restrict:"EA",replace:!0,scope:!0,controller:"nbPictureMapEditorOverlayUiAreasController",templateUrl:"../src/templates/nb-picture-map-editor-overlay-ui-areas.html?_="+Date.now(),link:function(a,b,c,d){d.init(),a.$on("$destroy",function(){d.destroy()})}}}b.module("nb.pictureMapEditor").directive("nbPictureMapEditorOverlayUiAreas",c)}(window,window.angular),angular.module("nb.pictureMapEditor.templates",["templates/nb-picture-map-editor-overlay-ui-areas.html","templates/nb-picture-map-editor-overlay-ui.html"]),angular.module("templates/nb-picture-map-editor-overlay-ui-areas.html",[]).run(["$templateCache",function(a){a.put("templates/nb-picture-map-editor-overlay-ui-areas.html",'<span class="picture-map-editor-overlay-ui-areas"\n	  ng-click="click($event)">\n	<span class="picture-map-editor-overlay-ui-area"\n		  ng-repeat="area in areas track by area.$$id"\n		  ng-attr-style="{{area.style|style}}"\n		  ng-dblclick="clickArea(area.$$id)"\n		  jqyoui-draggable="{animate: true, onStop: \'stopAreaDrag\'}"\n		  data-drag="true">\n		<span nb-icon\n			  data-id="{{overlay.icon.id}}"\n			  data-hover-id="{{overlay.icon.hoverId}}"></span>\n	</span>\n</span>')}]),angular.module("templates/nb-picture-map-editor-overlay-ui.html",[]).run(["$templateCache",function(a){a.put("templates/nb-picture-map-editor-overlay-ui.html",'<div class="picture-map-editor-overlay-ui">\n	<div ng-if="overlay.tools"\n		 class="picture-map-editor-overlay-ui-bar"\n		 jqyoui-draggable="{animate: true, onStop: \'stopBarDrag\'}"\n		 data-drag="true">\n		<ul class="picture-map-editor-overlay-ui-tools-content">\n			<li ng-repeat="group in overlay.tools track by group.$$id">\n				<div ng-switch="group.type">\n					<ul ng-switch-when="group"\n						class="picture-map-editor-overlay-ui-tools-group">\n						<li ng-repeat="tool in group.tools track by tool.$$id"\n							class="picture-map-editor-overlay-ui-tools-group-item">\n							<div ng-switch="tool.type">\n								<a ng-switch-when="button"\n								   ng-click="clickButton(tool.$$id)"\n								   ng-class="{\'active\': tool.$$active}"\n								   class="picture-map-editor-overlay-ui-tools-button"\n								   ng-attr-title="{{tool.title}}"\n								   ng-switch="tool.$$active">\n									<span ng-switch-when="true"\n										  nb-icon-once\n										  data-title="{{tool.title}}"\n										  data-color="{{overlay.buttonActiveColor}}"\n										  data-id="{{tool.icon.id}}"\n										  data-hover-id="{{tool.icon.hoverId}}"></span>\n									<span ng-switch-default\n										  nb-icon-once\n										  data-title="{{tool.title}}"\n										  data-color="{{overlay.buttonColor}}"\n										  data-id="{{tool.icon.id}}"\n										  data-hover-id="{{tool.icon.hoverId}}"></span>\n								</a>\n							</div>\n						</li>\n					</ul>\n					<div ng-switch-default\n						 class="picture-map-editor-overlay-ui-tools-single">\n						<div ng-switch="group.type">\n							<a ng-switch-when="button"\n							   ng-click="clickButton(group.$$id)"\n							   ng-class="{\'active\': group.$$active}"\n							   class="picture-map-editor-overlay-ui-tools-button"\n							   ng-attr-title="{{group.title}}"\n							   ng-switch="group.$$active">\n								<span ng-switch-when="true"\n									  nb-icon-once\n									  data-title="{{group.title}}"\n									  data-color="{{overlay.buttonActiveColor}}"\n									  data-id="{{group.icon.id}}"\n									  data-hover-id="{{group.icon.hoverId}}"></span>\n								<span ng-switch-default\n									  nb-icon-once\n									  data-title="{{group.title}}"\n									  data-color="{{overlay.buttonColor}}"\n									  data-id="{{group.icon.id}}"\n									  data-hover-id="{{group.icon.hoverId}}"></span>\n							</a>\n						</div>\n					</div>\n				</div>\n			</li>\n		</ul>\n	</div>\n	<div nb-picture-map-editor-overlay-ui-areas></div>\n</div>\n')}]);